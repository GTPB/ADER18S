---
title: "ADER18S - Analysis of PBMC4k using Seurat"
author: "Daniel Neves"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(cache = TRUE)
```

# Introduction

```{r, message=FALSE}
library(Seurat)
library(gridExtra)
```

# Loading the raw UMI count matrix

First we load the raw UMI matrix into the R environment. *Seurat* provides a `Read10X` function to import a *sparse matrix* generated by `cellranger count`. 

```{r}
mat.raw <- Read10X(data.dir = "output_cellranger_full/outs/filtered_gene_bc_matrices/GRCh38")

dim(mat.raw)
```

We start here with the pre-filtered matrix provided by `cellranger` containing the set of 4321 high-confidence cells. So we can proceed immediately to create the *Seurat* object.

```{r}
sobj <- CreateSeuratObject(raw.data=mat.raw, min.cells = 5)

dim(sobj@data)
```

# Downstream analysis

Unlike in the previous tutorial, here the commands and results for each section are hidden by default. Try to go through each exercise on your own, by adapting the commands we used in MCA tutorial and running them in the R console.

When you arrive at a solution, or if you get stuck, click on the solution link below each section to show *one possible* approach to the problem.

## Exercise 1: Filter the raw UMI matrix

Check the distributions of UMI, gene counts and percent of mitochondrial RNA, and filter the barcodes appropriately.

*Note: while in the mouse genome annotation mitochondrial genes have names that start with `mt-` (lowercase), in the human annotation mitochondrial genes start with `MT-` (uppercase).*

<details><summary><b>Click Here to see one solution</b></summary>

```{r}
VlnPlot(sobj, features.plot = c("nUMI", "nGene"))
plot(sobj@meta.data$nUMI, sobj@meta.data$nGene, pch=20, cex=0.5)
```

```{r}
mito.genes <- grep("^MT-", rownames(sobj@data), value = TRUE)
percent.mito <- Matrix::colSums(sobj@data[mito.genes, ]) / Matrix::colSums(sobj@data)
sobj <- AddMetaData(sobj, metadata = percent.mito, col.name = "percent.mito")

VlnPlot(sobj, features.plot = c("nUMI", "nGene", "percent.mito"))
plot(sobj@meta.data$nUMI, sobj@meta.data$percent.mito, pch=20, cex=0.5)
```

```{r}
sobj <- FilterCells(sobj, subset.names = "nGene", high.thresholds = 3000)
sobj <- FilterCells(sobj, subset.names = "percent.mito", high.thresholds = 0.1)

dim(sobj@data)
```

</details>

## Exercise 2: Normalize the raw counts

<details><summary><b>Click Here to see one solution</b></summary>

```{r normalize}
sobj <- NormalizeData(sobj, normalization.method = "LogNormalize", scale.factor = median(sobj@meta.data$nUMI))
```

</details>

## Exercise 3: Select a subset of highly variable genes to use for dimensionality reduction and clustering

*Hint: Aim for a subset of 1,000 to 2,000 genes.* 

<details><summary><b>Click Here to see one solution</b></summary>

```{r vargenes}
sobj <- FindVariableGenes(sobj, mean.function = ExpMean, dispersion.function = LogVMR,  
                          x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 0.5)

length(sobj@var.genes)
```

```{r, fig.width=8}
hvginfo <- sobj@hvg.info[ sobj@var.genes, ]
highest.dispersion <- head(rownames(hvginfo)[ order(-hvginfo$gene.dispersion) ])
highest.mean <- head(rownames(hvginfo)[ order(-hvginfo$gene.mean) ])

VlnPlot(sobj, features.plot = highest.dispersion, point.size.use=0.5)
VlnPlot(sobj, features.plot = highest.mean, point.size.use=0.5)
```

</details>

## Exercise 4: Scale the normalized matrix, and perform a principal component analysis (PCA) 

After obtaining and visualizing the PCA, determine the number of PCs you are going to use for further analysis.

<details><summary><b>Click Here to see one solution</b></summary>

```{r scale}
sobj <- ScaleData(object = sobj, vars.to.regress = c("nUMI", "percent.mito"))
```

```{r, fig.width=8, fig.height=4}
sobj <- RunPCA(object = sobj, pc.genes = sobj@var.genes, pcs.compute = 40, do.print=FALSE)

p1 <- PCAPlot(object = sobj, dim.1 = 1, dim.2 = 2, do.return=TRUE) + theme(legend.pos="none")
p2 <- PCAPlot(object = sobj, dim.1 = 2, dim.2 = 3, do.return=TRUE) + theme(legend.pos="none")
grid.arrange(p1, p2, ncol=2)
```

```{r}
PCElbowPlot(sobj, num.pc = 40)
```

```{r, fig.height=10, fig.width=8}
PCHeatmap(sobj, pc.use = 1:15, cells.use = 500, do.balanced = TRUE, label.columns = FALSE)
VizPCA(sobj, pcs.use = 1:15, do.balanced = TRUE)
```

```{r}
# sobj <- JackStraw(sobj, num.pc = 40, num.replicate = 50, do.par=TRUE, display.progress = FALSE)
# sobj <- JackStrawPlot(sobj, PCs = 1:40)
# 
# plot(1:40, -log10(sobj@dr$pca@jackstraw@overall.p.values[,2]))
# abline(h=-log10(0.05))
```

</details>

## Exercise 5: Cluster the cells in the expression matrix and represent the clusters in a t-SNE plot

Try to select an appropriate value for the clustering `resolution` parameter, and the `perplexity` parameter of the t-SNE.

<details><summary><b>Click Here to see one solution</b></summary>

```{r clusters, fig.width=8, fig.height=4}
sobj <- FindClusters(sobj, reduction.type = "pca", dims.use = 1:15, 
    resolution = 0.8, print.output = 0, save.SNN = FALSE)

sobj <- RunTSNE(sobj, dims.use = 1:15, do.fast = TRUE, perplexity = 30)
TSNEPlot(sobj, do.label = TRUE)
```

</details>

## Exercise 6: Find marker genes for all clusters

Examine the top markers for all clusters, and determine if any of the clusters seem to be very similar. If this is the case, group similar clusters together, and repeat the marker gene discovery on the new clusters.

<details><summary><b>Click Here to see one solution</b></summary>

```{r}
markers <- FindAllMarkers(object = sobj, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
markers <- markers[ markers$p_val_adj < 0.01, ]

head(markers)
```

```{r, fig.width=8, fig.height=12}
top.markers <- do.call(rbind, lapply(split(markers, markers$cluster), head))
DoHeatmap(sobj, genes.use = top.markers$gene, slim.col.label = TRUE, remove.key = TRUE)
```

</details>

## Exercise 7: Identify cell subpolulations

Use the `VlnPlot` and `FeaturePlot` functions to examine the expresssion of the marker genes below. Can you indentify some of the cell subpopulations?  

| Markers | Cell Type |
|-----:---|-----:-----|
| IL7R	  | CD4 T cells |
|	CD14, LYZ	| CD14+ Monocytes |
|	MS4A1 |	B cells |
|	CD8A | CD8 T cells |
|	FCGR3A, MS4A7	FCGR3A+ | Monocytes |
|	GNLY, NKG7	| NK cells |
|	FCER1A, CST3	| Dendritic Cells |
|	PPBP	| Megakaryocytes |

<details><summary><b>Click Here to see one solution</b></summary>

```{r}
VlnPlot(sobj, features.plot = c("IL7R", "MS4A1"), point.size.use=0.2)
VlnPlot(sobj, features.plot = c("CD14", "LYZ", "FCGR3A", "MS4A7"), point.size.use=0.2)
VlnPlot(sobj, features.plot = c("MS4A1"), point.size.use=0.2)
VlnPlot(sobj, features.plot = c("FCER1A", "CST3"), point.size.use=0.2)
VlnPlot(sobj, features.plot = c("PPBP"), point.size.use=0.2)
```

```{r}
FeaturePlot(sobj, features.plot = c("IL7R", "MS4A1"), cols.use=c("grey", "red"), pt.size=0.5)
FeaturePlot(sobj, features.plot = c("CD14", "LYZ", "FCGR3A", "MS4A7"), cols.use=c("grey", "red"), pt.size=0.5)
FeaturePlot(sobj, features.plot = c("MS4A1"), cols.use=c("grey", "red"), pt.size=0.5)
FeaturePlot(sobj, features.plot = c("FCER1A", "CST3"), cols.use=c("grey", "red"), pt.size=0.5)
FeaturePlot(sobj, features.plot = c("PPBP"), cols.use=c("grey", "red"), pt.size=0.5)
```

</details>

# Session Information

```{r}
sessionInfo()
```

# References

- https://satijalab.org/seurat/pbmc3k_tutorial.html

